name: Run get_subtitles.py

on:
  workflow_dispatch:

concurrency:
  group: subtitle-acquisition
  cancel-in-progress: true

jobs:
  get-subtitles:
    runs-on: self-hosted
    permissions:
      contents: write
    defaults:
      run:
        working-directory: ./src/scripts
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1

      - name: Install Bun
        uses: oven-sh/setup-bun@v2.1.0
        with:
          bun-version: latest

      - name: Install FFmpeg
        uses: federicocarboni/setup-ffmpeg@v3.1

      - name: Install uv
        uses: astral-sh/setup-uv@v7.2.0
        with:
          version: latest
          python-version: 3.13

      - name: Install Python packages
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install b2[full]
          deactivate

          cd get_subtitles
          uv venv
          source .venv/bin/activate
          uv pip install -r requirements.txt
          uv pip install --upgrade --pre yt-dlp

      - name: Authenticate B2 CLI
        run: |
          source .venv/bin/activate
          b2 account authorize "${{ secrets.B2_APP_KEY_ID }}" "${{ secrets.B2_APP_KEY }}" &> /dev/null

      - name: Download Subtitles.json
        run: |
          source .venv/bin/activate
          b2 file download b2://jerma-subtitles/Subtitles.json ../assets/Subtitles.json

      - name: Write cookie file
        run: echo "${{ secrets.COOKIES }}" > get_subtitles/cookies.txt

      - name: Run get_subtitles.py
        run: |
          set +e
          cd get_subtitles
          source .venv/bin/activate
          MAX_TRIES=8
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_TRIES ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Running get_subtitles.py (attempt $ATTEMPT/$MAX_TRIES)..."

            TORCH_FORCE_NO_WEIGHTS_ONLY_LOAD=true python get_subtitles.py

            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo 'Script completed successfully.'
              break
            else
              if [ $ATTEMPT -lt $MAX_TRIES ]; then
                echo "Script crashed with exit code $EXIT_CODE. Restarting in 10 seconds..."
                sleep 10
              else
                echo "Script failed after $MAX_TRIES attempts. Giving up."
                exit 1
              fi
            fi
          done

      - name: Upload Subtitles.json
        run: |
          source .venv/bin/activate
          b2 file upload jerma-subtitles ../assets/Subtitles.json Subtitles.json &> /dev/null

      - name: Commit
        run: |
          cd ../../

          new_entries=()

          for file in $(git ls-files --others --exclude-standard src/assets/subtitles/*.lrc); do
            filename=$(basename "$file")

            title=$(jq -r --arg fname "$filename" '.[] | select(.subtitle_filename == $fname) | .title' src/assets/Subtitles.json)

            new_entries+=("$title")
            git add "$file"
            git commit -m "chore: add subtitles for $title"
          done

          git add src/scripts/get_subtitles/downloaded.txt
          git add src/scripts/get_subtitles/unavailable_videos.txt
          if [ -f src/scripts/get_subtitles/videos_with_no_subs.txt ]; then
            git add src/scripts/get_subtitles/videos_with_no_subs.txt
          fi
          git add src/scripts/get_subtitles/refined_subtitles.txt

          git commit -m 'chore: update logs'

      - name: Push
        run: git push
